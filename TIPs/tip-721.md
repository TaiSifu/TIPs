---
tip: 721
title: NFA 主合约基本行为命令接口规范
description: 规范 NFA 主合约的 eval 型查询命令接口，以实现 MUD 与 WebUI 客户端的兼容性。
author: TaiSifu (@TaiSifu)
discussions-to: https://github.com/hongzhongx/TIPs/discussions/9
status: Draft
type: Standards Track
category: Interface
created: 2026-01-28
requires: 7, 5
---
## 摘要

本提案规范了太乙网络中非同质资产（NFA）主合约（SGS）需要实现的一系列行为命令接口。这些接口包括 `eval` 型查询命令和 `do` 型行为命令。通过标准化这些接口，可以确保各类型客户端（如 MUD 类客户端 `ndanuo` 和 WebUI 类客户端 `vdanuo`）能够以一致的方式获取 NFA 状态并与之交互。本规范特别涵盖了基础描述命令以及用于实现 NFA “拟人化”或“状态展示”的高级命令。

## 动机

目前太乙网络中的 NFA 合约实现各异，导致客户端在适配不同 NFA（特别是角色 Actor、区域 Zone 和各种法宝物件）时需要编写大量的特殊处理逻辑。

为了提升开发效率并增强不同项目间的互操作性，需要制定一套通用的指令规范：

1. **跨客户端兼容性**：心素开发的 NFA 合约不仅能支持最简单的命令行（MUD）应用，也能无缝兼容图形化界面（如 `vdanuo`），后者可以直接调用这些命令获取结构化或格式化的信息并展示在 UI 面板中。
2. **NFA 拟人化与泛化**：太乙网络的理念是允许玩家以“第一人称”视角接入任何 NFA。因此，无论是一个普通角色，还是一个书本、一个法宝，甚至是一个区域，都应当具备一套标准的接口来表达其外观、状态、所持/含物等信息。

## 规范说明

本文中的关键术语 "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY" 和 "OPTIONAL" 均按照 RFC 2119 解释。

### 基础 `eval` 型查询接口

所有 NFA 主合约 **SHOULD** 实现以下基础查询命令，这些命令通常用于返回 NFA 的基本文本描述。对于 eval 型查询接口的函数命名以及预定义方式，参考 [TIP-7](./tip-7.md)。

#### `short`

* **用途**：返回 NFA 的简短名称或标题。
* **参数**：无。
* **返回格式**：`table` (数组)，通常包含一个字符串。
* **示例**：`return { "路引" }`

#### `long`

* **用途**：返回 NFA 的详细描述。
* **参数**：无。
* **返回格式**：`table` (数组)，通常包含一段详细的描述字符串。
* **示例**：`return { "这是一本大梁监天司颁发的路引..." }`

#### `help`

* **用途**：返回该 NFA 支持的所有命令及使用说明。
* **参数**：无。
* **返回格式**：通常是通过 `contract_helper:narrate` 输出一段帮助文本。

### 状态 `eval` 型查询接口

为了支持图形化界面的状态面板展示，任何 NFA **MAY** 实现以下状态查询接口以提供其作为“第一人称”视角时的状态数据。

#### `hp`

* **用途**：返回 NFA 的生命状态、真气或其他核心属性。
* **参数**：hp (target, option)
  * `target`: string，目标名称，默认空字符串表示自己。
  * `option`: string，查询选项（如 空字符串表示基本信息，`-c` 表示属性状态，`-l` 表示详细格式等等）。
* **返回格式**：通过 `contract_helper:narrate` 输出状态信息。

#### `inventory`

* **用途**：返回 NFA 的包裹或内部持有的物品列表。
* **参数**：inventory (target, options)
  * `target`: string，目标名称，默认空字符串表示自己。
  * `options`: string，查询选项（如 空字符串表示基本列表，`-l` 表示详细格式等等）。
* **返回格式**：通过 `contract_helper:narrate` 输出物品/实体列表。

#### `resource`

* **用途**：返回 NFA 持有的资源（如基本资源、自身材料等）。
* **参数**：resource (target, option)
  * `target`: string，目标名称，默认空字符串表示自己。
  * `option`: string，查询选项（如 空字符串表示持有的基本资产，`-m` 表示自身由哪些材料组成等等）。
* **返回格式**：通过 `contract_helper:narrate` 输出资源统计信息。

#### `map`

* **用途**：返回 NFA 所在区域或其视角下的拓扑信息。
* **参数**：map (target)
  * `target`: string，目标名称，默认空字符串表示自己。
* **返回格式**：通过 `contract_helper:narrate` 输出地图或者拓扑信息。

#### `welcome`

* **用途**：当玩家接入该 NFA 时触发的欢迎信息。
* **参数**：无。
* **返回格式**：通过 `contract_helper:narrate` 输出介绍性背景或欢迎词。

## 基本原理

1. **接口一致性**：通过 `eval_` 或者 `do_` 前缀区分只读查询和修改操作，允许客户端在不消耗真气的情况下安全预览状态（参考 [TIP-7](./tip-7.md)）。
2. **叙述化输出**：利用 `contract_helper:narrate` 返回格式化文本（支持 ANSI 颜色代码），使得后端逻辑可以复用于 MUD 终端和富文本 Web UI。
3. **泛化设计**：不仅限于角色 Actor。例如，一个“录音机” NFA 也可以实现 `inventory` 以显示其内部的磁带，或通过 `hp` 显示剩余电量。

## 向后兼容性

本标准是对现有 NFA 实践的概括与规范，不影响不支持这些接口的旧版合约的运行。但为了获得更好的客户端支持，推荐逐步迁移至本标准。

## 测试用例

参考 [`taiyi-contracts`](https://github.com/hongzhongx/taiyi-contracts) 项目中的以下合约实现：

* `nfas/luyin.lua` (一个物品 `路引`的基础接口实现)
* `nfas/actors/normal.lua` (一个凡人角色的全量接口实现)

## 参考实现

```lua
-- 标准 TIP-721 NFA 结构示例
short = { consequence = false }
hp = { consequence = false }

function eval_short()
    return { "标准NFA" }
end

function eval_hp()
    contract_helper:narrate("状态: 完好\n真气: 100/100", false)
end
```

## 安全性注意事项

`eval` 型函数绝对禁止执行任何改变 NFA 状态的操作（如 `nfa_helper:write_contract_data` 或任何 `withdraw/deposit`）。所有 `consequence = false` 的操作应在只读上下文中视作纯函数（具体参考 [TIP-7](./tip-7.md)）。

## 版权许可

依据 [CC0](../LICENSE) 协议放弃所有版权及相关权利。
